<?php


define('REDIRECT_URI', 'http://yadmin.sanlinmail.site/auth.php');
define('AUTH_URL', 'https://allegro.pl/auth/oauth/authorize');
define('TOKEN_URL', 'https://allegro.pl/auth/oauth/token');

//DYUU
//define('CLIENT_ID', '85bac0c807f0410caada7509963954d1');
//define('CLIENT_SECRET', 'FkwiVuqAgM67PRkueR06mwFotOcgpQ4WN5HbOZtqXjHCNgpurraGBvwmOAkZ6RqU');
//define('SHOP_ID', '5');

//HTTN
//define('CLIENT_ID', 'b231e1dfa7df48f3b8c849c757543ae8');
//define('CLIENT_SECRET', 'jQHoIsmDf89XpkK2Xalr9Svo0RrSNQe0OMx8rPIrpepYRWYVt5DOEhdjYZY5MLeU');
//define('SHOP_ID', '14');

//DGH
//define('CLIENT_ID', 'e5ac1a6384f942a0bb261794853db70d');
//define('CLIENT_SECRET', 'nqUJqwQVmRcp3VqfFe3o5fxkgBzgGDvmq2FhnWTHkXtrbvsZp2VoxHbyo3cV3v3h');
//define('SHOP_ID', '15');

//Cegar-Direct
//define('CLIENT_ID', 'a5c6f5af36874a5a84b37687cc40dd60');
//define('CLIENT_SECRET', 'bHNdCNrbcvXxIMVYtIHHIcoT3sIKnNQzf2xiFSPDDytNxJkNbM5NotaFzLKawPIy');
//define('SHOP_ID', '4');

//Hanfei
//define('CLIENT_ID', '7d889947653044b8a0c01b15d048421b');
//define('CLIENT_SECRET', '4kj5B151aZjbsExDJWEjYBLknzbEZvZNDrSeCCTxHTBEEMzjECkTHwAp3gB0QS7t');
//define('SHOP_ID', '16');

//THUNDERLA
//define('CLIENT_ID', 'd86e5b31c3274b7387a38a0c008403e9');
//define('CLIENT_SECRET', 'Ycn582xASSkHWw9j1ABPsZojYJrprUFyYJQqK03my5l3MRInW3IZhDAjINlXwmBJ');
//define('SHOP_ID', '17');

//COMEBUY
//define('CLIENT_ID', '974fa301dbbf4cea9ce594b938c76232');
//define('CLIENT_SECRET', 'WSEnC0CQLQhxPPl1jyGLwPsmMwjr3qFgjL7PnwDTjo3S5FO1wUsDGQ93q5Z8s18e');

//Butikow
//define('CLIENT_ID', '43ab67d135b84173a57ba053dd12570e');
//define('CLIENT_SECRET', 'u2kUQdcoOtzi0tWpihdrTl9Cth8QU31Vv0z7eXLYX60MTYrUCuM2bYL6Id6zJNM3');

//GHCD
//define('CLIENT_ID', 'f6c73d5b7e05432dadc2f91c93279ec3');
//define('CLIENT_SECRET', 'mMp7uDB5lCNYOCbApJrUJiucpuTrZHEEfONIG7HxxwEolaBGe7sT3N1nynKxm0mF');

//KH-Coltd
//define('CLIENT_ID', 'a4dcc38761d648f5a3307849b9583f2f');
//define('CLIENT_SECRET', 'htKpLFLEGdOq9je6owwnWnjTPERfiPzHi1two0ZYJDJSaCVsqhHNrw8eHIqo2pD1');

//INSOUL
//define('CLIENT_ID', '1b5df8f17805499898c76a1a7fbe1473');
//define('CLIENT_SECRET', 'G3MhgJCYhTGtY4B0z6soLgoMvkbGINVTWr9jhaBcZa0aVMw3nyyK1X5a78fJNMn5');

//HT-Coltd
//define('CLIENT_ID', 'e55a96c79b934dbb875483868aef3a37');
//define('CLIENT_SECRET', 'nv7HsZPcmMTqTR5v8zgtZbAzTI1Qr7tVntyS7iUSWAfGAhvbPWQg5dmOq0jlSoYe');

//FLONE
//define('CLIENT_ID', '4395eac1715b412f891874b38372fd7b');
//define('CLIENT_SECRET', '92v8hXkGsNGVmtiqMFboVWOeDatls5eeCo7vAWr7GElnxig3FJBFzILe3TbA7i8c');

//Oncen
//define('CLIENT_ID', '55cda1ad66224e2c9df2fb796828f9a9');
//define('CLIENT_SECRET', 'uPMgjfATQW7i1C62gDsDDRH8YrISxrD7HNaEpCM7P2kPydPiTjkjgvP8ESSAkueE');

//Wing-GD
//define('CLIENT_ID', '3bbed00e3c3e415caf30f0f5330a0604');
//define('CLIENT_SECRET', 'XCruX5RwY2jh0aE8UzkCn2SZ9bMc1NcSZ0PzmiMtEAwrgoISD851TzhHjeOMHbmY');

//DDGE    旧名称 FDG
//define('CLIENT_ID', '86c8047f916b48fb9fc013ae4677bf48');
//define('CLIENT_SECRET', 'BsUzi1Juj51wYiJrz92sTxDVcj4jrKenHfWJ70MHHAS6DxGkHMINjajcpTEhczQD');

//YBean
//define('CLIENT_ID', '01549232cdbf4044b0b397d5f804be54');
//define('CLIENT_SECRET', '1DevygwqNMA7cudZoS2m8eOMA9VtWKIljgAheaRzSwd73KYnXszJhPZ1F16HlDgj');

//HPF
//define('CLIENT_ID', 'c65eddf5b6764c2eb6237be53d5d52bc');
//define('CLIENT_SECRET', 'w8ONqTJgs3sj1eiYJo7kVbJUet9rghFId9GQx30eIeZeNyYdoQisvuNkXK72WJkm');

//Soul-In
//define('CLIENT_ID', '91da7048321d411cb9b3a87ba5d57ff0');
//define('CLIENT_SECRET', 'oZbWTlmL7Tyh2rVWHizDUwh7fw2d9J5UxJvHpkZQrkQhaoPubWLHuXhVbgJxnbtr');

//GIVENI
//define('CLIENT_ID', 'fe7bc89f525d4bb4bde7b90f7038e654');
//define('CLIENT_SECRET', 't4sOc4fWruOIn7cmRB7LIlmcAsmBKv8o1uxlsanFQ4jTrJwiSaBqNDlcnirnPApH');

//FTYY
//define('CLIENT_ID', 'f6c18b94cb314c43a30cb62b8bfe2047');
//define('CLIENT_SECRET', 'G7eF9kstRjHcMgs0eJv7HOHpEVi4N4dleIexriRtqVbG9yYhoMTB0ZoAJozgkxNh');


//TPKE
//define('CLIENT_ID', '4d3dbd3b36024638963f84dd3b407d8c');
//define('CLIENT_SECRET', 'BKbts3UuhX8Jz7zYRy258jAR2pCg9krXM6mX17hSiC9mGkkKyyJ4VTCevNlu6MxE');

////M-Dream
//define('CLIENT_ID', '341b2873db6f4f649db6fb9a2cd887ce');
//define('CLIENT_SECRET', 'WfZk2NtG08yEpOt4ExMzQ5waV5X55xzxTCrA4XNktGL6b5G552dOQ6nPeyQhi1xg');
//
//
////DAHAL
//define('CLIENT_ID', '7ae9fd27cb184f39b12c5ccab9efc23b');
//define('CLIENT_SECRET', 'BS5yDyKjzbjjbH1xmahxKbc9EOG4NI4Bb53uqzF04KsdCGeOtYFxwsLE3x8jLnkr');
//
////TAKIK
//define('CLIENT_ID', '3de0b9a0227f4e4288858c2323c41ad3');
//define('CLIENT_SECRET', 'D07ABa5FYKvcFvDlXfVhIrtNkJMThnhQ3AsVYd4xZ7nGuPw55hoCJsrSXgNatjb0');
//
////ONE-PLUS
//define('CLIENT_ID', '69bf4d5a14c047b78b5f18b5c872fca6');
//define('CLIENT_SECRET', 'PS1mekl83jMOz8r5EhiAgNe7yhQiU3KuJca2RPmmTdsbfZ2IVqPDdgGnHDrOpex4');

////TAFF
//define('CLIENT_ID', '97b779079ad74e1d9fb5b5d59b3f7dcb');
//define('CLIENT_SECRET', 'hMDpJ12CwrbbThey1PIMAGqLtXgKIZOG43cXSdcm8O9mikjxLdkbExoYFERyxQbn');
//
////SL-BEAN
//define('CLIENT_ID', 'dbaaf174d64047529d151d4debfdffc5');
//define('CLIENT_SECRET', '0oCI96mkfQTLMtd2KRrQWXyEQU13rxneXVRWZ0oWv6QGYT4OZUE9uw1km99bqLyb');

//IMNI
//define('CLIENT_ID', '92c3b29496ef412d83a926e14b3e783b');
//define('CLIENT_SECRET', '1kUxLyuYn6gxdF6RyBG9ZFDkjplYnaB7BTq7GXk71WTYFoz2XEXuJlOzdTieFgsL');

//GuoRan
//define('CLIENT_ID', '5574ea972f2b4339be3634378a5c3b85');
//define('CLIENT_SECRET', 'YE8DpzdsvfXrYYaDnpJ6HOcW4eAoVPXrzNrLIc3K7Iz5RWJGpRHawDgQOL40Gcx6');

//Qixun-Coltd
//define('CLIENT_ID', '0c824773188e4f88b95ec0aa8721fa15');
//define('CLIENT_SECRET', 'LidgLtnghpMRZucUJdCGOkXmtjyl4kp0CBcIUWgqWrOqky40wBcb2HzURdpOKpyK');

//XINHANG
//define('CLIENT_ID', '98e2b1f07b394fa6888c4d309675cc05');
//define('CLIENT_SECRET', 'xb5LvDsnxgcnEAzqYqRFzeqoJmFdAd2SksAJKde0WhsepTJBgSLnCdUFxn8yKT5W');

function getAuthorizationCode() {
    $authorization_redirect_url = AUTH_URL . "?response_type=code&client_id="
        . CLIENT_ID . "&redirect_uri=" . REDIRECT_URI;
    ?>
    <html>
    <body>
    <a href="<?php echo $authorization_redirect_url; ?>">Zaloguj do Allegro</a>
    </body>
    </html>
    <?php
}


function getCurl($headers, $content) {
    $ch = curl_init();
    curl_setopt_array($ch, array(
        CURLOPT_URL => TOKEN_URL,
        CURLOPT_HTTPHEADER => $headers,
        CURLOPT_SSL_VERIFYPEER => false,
        CURLOPT_RETURNTRANSFER => true,
        CURLOPT_POST => true,
        CURLOPT_POSTFIELDS => $content
    ));
    return $ch;
}


function getAccessToken($authorization_code) {
    $authorization = base64_encode(CLIENT_ID.':'.CLIENT_SECRET);
    $authorization_code = urlencode($authorization_code);
    $headers = array("Authorization: Basic {$authorization}","Content-Type: application/x-www-form-urlencoded");
    $content = "grant_type=authorization_code&code=${authorization_code}&prompt=confirm&redirect_uri=" . REDIRECT_URI;
    $ch = getCurl($headers, $content);
    $tokenResult = curl_exec($ch);
    $resultCode = curl_getinfo($ch, CURLINFO_HTTP_CODE);
    curl_close($ch);

    if ($tokenResult === false || $resultCode !== 200) {
        exit ("Something went wrong $resultCode $tokenResult");
    }
    $result = json_decode($tokenResult,true);

    //echo json_encode(['refresh_token'=>$result['refresh_token'],'shop_id'=>SHOP_ID]);
    echo json_encode(['refresh_token'=>$result['refresh_token']]);
    echo "\n";
    return $result['access_token'];
}


function reAccessToken($authorization_code) {
    $authorization = base64_encode(CLIENT_ID.':'.CLIENT_SECRET);
    $authorization_code = urlencode($authorization_code);
    $headers = array("Authorization: Basic {$authorization}","Content-Type: application/x-www-form-urlencoded");
    $content = "grant_type=refresh_token&refresh_token=${authorization_code}&redirect_uri=" . REDIRECT_URI;
    $ch = getCurl($headers, $content);
    $tokenResult = curl_exec($ch);
    $resultCode = curl_getinfo($ch, CURLINFO_HTTP_CODE);
    curl_close($ch);

    if ($tokenResult === false || $resultCode !== 200) {
        exit ("Something went wrong $resultCode $tokenResult");
    }
    $result = json_decode($tokenResult);

    var_dump($result);
    return $result->access_token;
}

function main(){
    if ($_GET["code"]) {
        $access_token = getAccessToken($_GET["code"]);
        //echo "access_token = ", $access_token;
    } else if ($_GET["re"]) {
        $access_token = reAccessToken('eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX25hbWUiOiI5ODMzMzQ5NiIsInNjb3BlIjpbImFsbGVncm86YXBpOm9yZGVyczpyZWFkIiwiYWxsZWdybzphcGk6cHJvZmlsZTp3cml0ZSIsImFsbGVncm86YXBpOnNhbGU6b2ZmZXJzOndyaXRlIiwiYWxsZWdybzphcGk6YmlsbGluZzpyZWFkIiwiYWxsZWdybzphcGk6Y2FtcGFpZ25zIiwiYWxsZWdybzphcGk6ZGlzcHV0ZXMiLCJhbGxlZ3JvOmFwaTpzYWxlOm9mZmVyczpyZWFkIiwiYWxsZWdybzphcGk6YmlkcyIsImFsbGVncm86YXBpOm9yZGVyczp3cml0ZSIsImFsbGVncm86YXBpOmFkcyIsImFsbGVncm86YXBpOnBheW1lbnRzOndyaXRlIiwiYWxsZWdybzphcGk6c2FsZTpzZXR0aW5nczp3cml0ZSIsImFsbGVncm86YXBpOnByb2ZpbGU6cmVhZCIsImFsbGVncm86YXBpOnJhdGluZ3MiLCJhbGxlZ3JvOmFwaTpzYWxlOnNldHRpbmdzOnJlYWQiLCJhbGxlZ3JvOmFwaTpwYXltZW50czpyZWFkIl0sImFsbGVncm9fYXBpIjp0cnVlLCJhdGkiOiJlZTFjMTgxMi1mMjI2LTQ5MWUtODBhYS00N2U5ZWQ0OTA2NjYiLCJleHAiOjE2MzA4NDAyMTYsImp0aSI6ImNlNzJhMjYwLTNiYjAtNDM4YS1iNTk4LTU1Y2EwNzZmNWIwNCIsImNsaWVudF9pZCI6Ijg1YmFjMGM4MDdmMDQxMGNhYWRhNzUwOTk2Mzk1NGQxIn0.fKpB82wl5F8OeLWwVLBc-ECPSXV3V_lHgMCBlVkhc8A9j8pPv7HkkZP1JRpCa0xa9rp92nqC0Z_wYE70v6Pg6U8w2bmncKJoIu78yliR2WLBMCwQCDjsMPMzVrCCrAjNo00J3YUH8hL2gnLAm0onwJs7sRy42zNj5rLXmrszeWDh8Am3-6WKKLNynCFwYKnnS0J2h06oChZeqfWSqpNuJkSxtj4U_HGAt7VH1CDxlXF8pRs8fGOcjsetdsLeXIR2fSwDWtO00DGuNOMa1dfpHNk3-jBnzdp9uU09GNrhOmS40J5x1AR9IDNCWnXgkUwdDQmEONsGFBxjPlFNNtu1Pw');
        echo "access_token = ", $access_token;
    } else {
        getAuthorizationCode();
    }
}


main();

?>